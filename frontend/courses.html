<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Courses | Attendance Manager</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <nav class="navbar">
        <div class="navbar-container">
            <div class="navbar-brand">
                <span class="brand-icon">üë®‚Äçüè´</span>
                Teacher Portal
            </div>
            <div class="navbar-menu">
                <a href="teacher.html" class="btn btn-secondary" style="margin-right: 10px;">‚Üê Back</a>
                <span id="teacherName" class="user-name" style="margin-right: 20px;"></span>
                <button onclick="logout()" class="btn btn-secondary">Logout</button>
            </div>
        </div>
    </nav>

    <main class="dashboard-container">
        <div style="display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 2rem;">
            <div>
                <h1>üìö Manage Your Courses</h1>
                <p style="color: var(--text-muted); font-size: 1.1rem; margin-top: 0.5rem;">Create and modify your
                    subjects</p>
            </div>
            <button onclick="showAddCourseForm()" class="btn btn-primary">+ Add New Course</button>
        </div>

        <!-- Courses List -->
        <section>
            <div id="coursesList" class="courses-grid">
                <div class="loading">Loading courses...</div>
            </div>
        </section>

        <!-- Add/Edit Course Modal -->
        <div id="courseModal" class="modal">
            <div class="modal-content">
                <button class="modal-close" onclick="closeCourseModal()">‚úï</button>
                <div style="margin-bottom: 2rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                    <h2 id="modalTitle" style="margin: 0;">Add New Course</h2>
                </div>
                <form id="courseForm">
                    <div class="form-group">
                        <label for="courseCode">Course Code *</label>
                        <input type="text" id="courseCode" placeholder="e.g., CS101" required>
                    </div>
                    <div class="form-group">
                        <label for="courseName">Course Name *</label>
                        <input type="text" id="courseName" placeholder="e.g., Data Structures" required>
                    </div>
                    <div class="form-group">
                        <label for="description">Description</label>
                        <textarea id="description" placeholder="Course description" rows="3"></textarea>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
                        <div class="form-group">
                            <label for="credits">Credits</label>
                            <input type="number" id="credits" placeholder="3" value="3">
                        </div>
                        <div class="form-group">
                            <label for="semester">Semester</label>
                            <input type="text" id="semester" placeholder="Spring 2026" value="Spring 2026">
                        </div>
                    </div>
                    <div style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 1rem;">
                        <button type="button" class="btn btn-secondary" onclick="closeCourseModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save Course</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Class Details Modal -->
        <div id="classModal" class="modal">
            <div class="modal-content" style="max-width: 800px;">
                <button class="modal-close" onclick="closeClassModal()">‚úï</button>
                <div
                    style="margin-bottom: 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 1rem;">
                    <h2 id="classModalTitle" style="margin: 0;"></h2>
                </div>
                <div id="classDetails"></div>
                <div style="margin-top: 2rem; display: flex; justify-content: flex-end;">
                    <button class="btn btn-secondary" onclick="closeClassModal()">Close</button>
                </div>
            </div>
        </div>
    </main>

    <script src="js/config.js"></script>
    <script>
        let currentCourseId = null;

        async function loadMyCourses() {
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/courses/my-courses`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    displayCourses(data.courses);
                } else {
                    document.getElementById('coursesList').innerHTML =
                        '<p class="error-message">Failed to load courses</p>';
                }
            } catch (err) {
                console.error('Error loading courses:', err);
                document.getElementById('coursesList').innerHTML =
                    '<p class="error-message">Error loading courses</p>';
            }
        }

        function displayCourses(courses) {
            const container = document.getElementById('coursesList');

            if (courses.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 4rem; background: var(--glass-bg); border-radius: 20px; border: 1px dashed rgba(255,255,255,0.1);"><div style="font-size: 3rem; opacity: 0.5; margin-bottom: 1rem;">üìö</div><p style="color: var(--text-muted);">No courses created yet. Click "Add New Course" to get started!</p></div>';
                return;
            }

            container.innerHTML = courses.map(course => `
                <div class="class-card">
                    <div class="class-header">
                        <div>
                            <span class="class-code">${course.course_code}</span>
                            <h3 style="margin-top: 0.8rem; font-size: 1.35rem;">${course.course_name}</h3>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-direction: column; align-items: flex-end;">
                            <button onclick="editCourse(${course.id}, '${course.course_code}', '${course.course_name}')" class="btn-small btn-secondary" style="border:none;">‚úèÔ∏è Edit</button>
                            <button onclick="deleteCourse(${course.id})" class="btn-small danger" style="padding: 0.4rem 0.8rem;">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div style="margin: 1.5rem 0;">
                        <div style="display:flex; justify-content:space-between; margin-bottom: 0.5rem; font-size: 0.95rem;">
                            <span style="color: var(--text-muted);">Credits</span> <span style="font-weight: 500;">${course.credits}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom: 0.5rem; font-size: 0.95rem;">
                            <span style="color: var(--text-muted);">Semester</span> <span style="font-weight: 500;">${course.semester}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom: 0.5rem; font-size: 0.95rem;">
                            <span style="color: var(--text-muted);">Sections</span> <span style="font-weight: 500;">${course.num_sections}</span>
                        </div>
                        <div style="display:flex; justify-content:space-between; margin-bottom: 0.5rem; font-size: 0.95rem;">
                            <span style="color: var(--text-muted);">Total Enrolled</span> <span style="font-weight: 500;">${course.total_enrolled}</span>
                        </div>
                    </div>
                    <div style="margin-top: 1.5rem; display: flex;">
                        <button onclick="showClasses(${course.id}, '${course.course_name}')" class="btn btn-primary" style="width: 100%;">View Classes</button>
                    </div>
                </div>
            `).join('');
        }

        function showAddCourseForm() {
            currentCourseId = null;
            document.getElementById('modalTitle').textContent = 'Add New Course';
            document.getElementById('courseForm').reset();
            document.getElementById('courseModal').classList.add('active');
        }

        function editCourse(courseId, courseCode, courseName) {
            currentCourseId = courseId;
            document.getElementById('modalTitle').textContent = 'Edit Course';
            document.getElementById('courseCode').value = courseCode;
            document.getElementById('courseName').value = courseName;
            document.getElementById('courseModal').classList.add('active');
        }

        document.getElementById('courseForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const courseData = {
                course_code: document.getElementById('courseCode').value,
                course_name: document.getElementById('courseName').value,
                subject_description: document.getElementById('description').value,
                credits: parseInt(document.getElementById('credits').value),
                semester: document.getElementById('semester').value
            };

            try {
                const token = getAuthToken();
                const url = currentCourseId
                    ? `${API_BASE_URL}/courses/${currentCourseId}`
                    : `${API_BASE_URL}/courses`;

                const method = currentCourseId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(courseData)
                });

                const data = await response.json();
                if (data.success) {
                    closeCourseModal();
                    loadMyCourses();
                } else {
                    alert('Error: ' + (data.message || 'Failed to save course'));
                }
            } catch (err) {
                console.error('Error saving course:', err);
                alert('Error saving course');
            }
        });

        async function deleteCourse(courseId) {
            if (!confirm('Are you sure you want to delete this course? All associated classes and attendance records will be deleted.')) {
                return;
            }

            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/courses/${courseId}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                if (data.success) {
                    loadMyCourses();
                } else {
                    alert('Error: ' + (data.message || 'Failed to delete course'));
                }
            } catch (err) {
                console.error('Error deleting course:', err);
                alert('Error deleting course');
            }
        }

        async function showClasses(courseId, courseName) {
            try {
                const token = getAuthToken();
                const response = await fetch(`${API_BASE_URL}/classes/course/${courseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    let classesHtml = `<p style="color: var(--text-muted); margin-bottom: 1rem;"><strong>Course:</strong> ${courseName}</p>`;
                    if (data.classes.length > 0) {
                        classesHtml += '<div class="attendance-table"><table>';
                        classesHtml += '<thead><tr><th>Code</th><th>Section</th><th>Schedule</th><th>Room</th><th>Enrolled</th></tr></thead><tbody>';
                        data.classes.forEach(cls => {
                            classesHtml += `<tr>
                                <td><span style="font-weight: 500;">${cls.class_code}</span></td>
                                <td>${cls.section}</td>
                                <td>${cls.schedule || 'TBA'}</td>
                                <td>${cls.room_number || 'TBA'}</td>
                                <td><span style="padding: 0.2rem 0.6rem; background: rgba(59, 130, 246, 0.15); border-radius: 6px; color: var(--text-primary);">${cls.enrolled_count}</span></td>
                            </tr>`;
                        });
                        classesHtml += '</tbody></table></div>';
                    } else {
                        classesHtml += '<p style="color: var(--text-muted); text-align: center; padding: 2rem;">No classes for this course yet.</p>';
                    }

                    document.getElementById('classModalTitle').textContent = 'Course Classes';
                    document.getElementById('classDetails').innerHTML = classesHtml;
                    document.getElementById('classModal').classList.add('active');
                } else {
                    alert('Error loading classes');
                }
            } catch (err) {
                console.error('Error loading classes:', err);
                alert('Error loading classes');
            }
        }

        function closeCourseModal() {
            document.getElementById('courseModal').classList.remove('active');
        }

        function closeClassModal() {
            document.getElementById('classModal').classList.remove('active');
        }

        window.addEventListener('load', () => {
            const userStr = localStorage.getItem('user');
            if (userStr) {
                const user = JSON.parse(userStr);
                document.getElementById('teacherName').textContent = user.full_name;
            }
            loadMyCourses();
        });

        window.onclick = function (event) {
            const courseModal = document.getElementById('courseModal');
            const classModal = document.getElementById('classModal');
            if (event.target === courseModal) courseModal.classList.remove('active');
            if (event.target === classModal) classModal.classList.remove('active');
        }
    </script>
</body>

</html>